# Copyright 2018 FIX94
# This code is licensed to you under the terms of the GNU GPL, version 2;
# see file LICENSE or http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt

# Modifications made by AECX and Zephiles

#---------------------------------------------------------------------------------
# Clear the implicit built in rules
#---------------------------------------------------------------------------------
.SUFFIXES:
#---------------------------------------------------------------------------------
ifeq ($(strip $(DEVKITPPC)),)
$(error "Please set DEVKITPPC in your environment. export DEVKITPPC=<path to>/devkitPPC")
endif

CC = $(DEVKITPPC)/bin/powerpc-eabi-gcc
OBJCOPY = $(DEVKITPPC)/bin/powerpc-eabi-objcopy

LD = $(DEVKITPPC)/bin/powerpc-eabi-ld

# The compiler flags we need.

CFLAGS := -Wall -W -O1 -ffreestanding -mno-eabi -mno-sdata -mcpu=750

ifeq ($(VERSION),)
all: us jp eu
us:
	@$(MAKE) --no-print-directory VERSION=us
jp:
	@$(MAKE) --no-print-directory VERSION=jp
eu:
	@$(MAKE) --no-print-directory VERSION=eu

else

# Platform options
ifeq ($(VERSION),us)
	PRINTVER = US
else ifeq ($(VERSION),eu)
	PRINTVER = EU
else ifeq ($(VERSION),jp)
	PRINTVER = JP
endif

all: $(PRINTVER).bin

ttyd.%.o:
	@$(CC) $(CFLAGS) -DTTYD_$(PRINTVER) -c ttyd.c -o $@

start.o:
	@$(CC) $(CFLAGS) -c start.S -o start.o

%.elf: start.o ttyd.$(PRINTVER).o
	@echo "Linking... $@"
	@$(LD) -T ttyd.ld $^ -o $@ -Map=Main_$(PRINTVER).map

%.bin: ttyd.$(PRINTVER).elf
	@echo "Building... $@"
	@$(OBJCOPY) -Obinary $< Main_$(PRINTVER).bin

endif
clean:
	-rm -f *.o *.elf *.map *.bin